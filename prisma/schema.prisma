// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// GLOBAL TABLES (Shared across all tenants)
// ============================================================================

model User {
  id        String   @id @default(uuid())
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  email     String?  @unique
  phone     String?  @unique
  password  String
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relationships
  userTenants UserTenant[]
  sessions    Session[]

  @@map("users")
}

model Tenant {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  industry    String?
  description String?
  logoUrl     String?  @map("logo_url")
  country     String?
  defaultLocation String? @map("default_location")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relationships
  userTenants UserTenant[]

  @@map("tenants")
}

model UserTenant {
  id       String @id @default(uuid())
  userId   String @map("user_id")
  tenantId String @map("tenant_id")
  role     Role   @default(EMPLOYEE)
  isActive Boolean @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relationships
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@map("user_tenants")
}

model Session {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  tenantId     String?  @map("tenant_id")
  refreshToken String   @unique @map("refresh_token")
  deviceInfo   String?  @map("device_info")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// ============================================================================
// ENUMS
// ============================================================================

enum Role {
  OWNER
  ADMIN
  MANAGER
  EMPLOYEE
}

enum LocationType {
  HEADQUARTERS
  BRANCH
  WAREHOUSE
  FACTORY
}

enum BusinessType {
  MANUFACTURING
  TRADING
  BOTH
}

// ============================================================================
// TENANT-SPECIFIC TABLES (Schema per tenant approach)
// Note: These will be created dynamically for each tenant
// This is just the template structure
// ============================================================================

// Template for tenant-specific location table
// Actual table name will be: tenant_{tenantId}_locations
model TenantLocation {
  id            String      @id @default(uuid())
  tenantId      String      @map("tenant_id")
  name          String
  email         String?
  phone         String?
  country       String
  addressLine1  String      @map("address_line_1")
  addressLine2  String?     @map("address_line_2")
  city          String
  state         String
  pincode       String
  isDefault     Boolean     @default(false) @map("is_default")
  isHeadquarters Boolean    @default(false) @map("is_headquarters")
  locationType  LocationType @default(BRANCH) @map("location_type")
  imageUrl      String?     @map("image_url")
  isActive      Boolean     @default(true) @map("is_active")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  @@map("tenant_locations")
}

// Template for tenant-specific inventory items
model TenantInventoryItem {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  locationId  String   @map("location_id")
  name        String
  sku         String
  description String?
  category    String
  unit        String
  quantity    Decimal  @default(0)
  minStock    Decimal  @default(0) @map("min_stock")
  maxStock    Decimal? @map("max_stock")
  unitPrice   Decimal  @map("unit_price")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, sku])
  @@map("tenant_inventory_items")
}

// Template for tenant-specific production orders
model TenantProductionOrder {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  locationId   String   @map("location_id")
  orderNumber  String   @map("order_number")
  productName  String   @map("product_name")
  quantity     Decimal
  status       String   @default("PENDING")
  priority     String   @default("MEDIUM")
  startDate    DateTime? @map("start_date")
  endDate      DateTime? @map("end_date")
  completedAt  DateTime? @map("completed_at")
  notes        String?
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, orderNumber])
  @@map("tenant_production_orders")
}

// Template for tenant-specific quality records
model TenantQualityRecord {
  id            String   @id @default(uuid())
  tenantId      String   @map("tenant_id")
  locationId    String   @map("location_id")
  productionOrderId String? @map("production_order_id")
  inspectorId   String   @map("inspector_id")
  inspectionType String  @map("inspection_type")
  status        String   @default("PENDING")
  defectCount   Int      @default(0) @map("defect_count")
  passedCount   Int      @default(0) @map("passed_count")
  failedCount   Int      @default(0) @map("failed_count")
  notes         String?
  inspectedAt   DateTime @default(now()) @map("inspected_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("tenant_quality_records")
}

// Template for tenant-specific financial transactions
model TenantFinancialTransaction {
  id            String   @id @default(uuid())
  tenantId      String   @map("tenant_id")
  locationId    String?  @map("location_id")
  transactionType String @map("transaction_type")
  referenceId   String?  @map("reference_id")
  amount        Decimal
  currency      String   @default("USD")
  description   String?
  status        String   @default("PENDING")
  transactionDate DateTime @default(now()) @map("transaction_date")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("tenant_financial_transactions")
}

// Template for tenant-specific suppliers
model TenantSupplier {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  name         String
  contactPerson String? @map("contact_person")
  email        String?
  phone        String?
  address      String?
  city         String?
  state        String?
  country      String?
  pincode      String?
  taxId        String?  @map("tax_id")
  paymentTerms String?  @map("payment_terms")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("tenant_suppliers")
}

// Template for tenant-specific customers
model TenantCustomer {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  name         String
  contactPerson String? @map("contact_person")
  email        String?
  phone        String?
  address      String?
  city         String?
  state        String?
  country      String?
  pincode      String?
  taxId        String?  @map("tax_id")
  creditLimit  Decimal? @map("credit_limit")
  paymentTerms String?  @map("payment_terms")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("tenant_customers")
}
